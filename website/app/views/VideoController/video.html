#{extends 'main.html' /}
#{set title: "${video.title}" /}
#{stylesheet 'video-page.css'/}

*{<script type="text/javascript" src="http://localhost:8080/socket.io/socket.io.js"></script>}*

<div class="page-header">
    <h1>${video.title}</h1>
</div>
<div id="container">
    <div id="player"></div>

*{<script src="https://www.youtube.com/iframe_api"></script>}*
    <script>




        function onYouTubeIframeAPIReady() {
            player = new YT.Player('player', {
                height: '390',
                width: '640',
                videoId: '${video.url}',
                events: {
                    'onStateChange': onPlayerStateChange
                }
            });
        }

        function onPlayerStateChange(event) {
            if (event.data === 1) {  //if the video is playing start catching events
                checkTimePointsOnVideo();
            }
        }


        /* !!!contains timer that runs slideTimeline */
        function checkTimePointsOnVideo() {
            addTimeToPanel();
            /* catches all timepoints on the video*/

            if (!player.getCurrentTime) {
                return false;
            }

            var interval = setInterval(function () {
                /* player.getPlayerState() -- Possible values are unstarted (-1), ended (0), playing (1), paused (2), buffering (3), video cued (5). */
                if (player.getPlayerState() === 1) {
                    var played = Math.round(player.getCurrentTime());
                    slideTimeline(played);
                } else if (player.getPlayerState() === 0 || player.getPlayerState() === 2) {
                    clearInterval(interval);
                }
            }, 1000);
        }

    </script>

    <script src="https://www.youtube.com/iframe_api"></script>


</div>

<div class="clearfix"></div>

<div id="slideHandler">
    <input id="autoslide" type="checkbox" checked="checked"/>
    Automatically slide
</div>
<div id="timeline-wrapper">
    <img src="/public/img/add-pointer.png" id="add-note-pointer" style="margin-bottom: -20px" type="button" data-toggle="modal"
         data-target="#addNote"/>

    <div id="timeline">
        <div id="noNotesAvailable" class="panel panel-default">
            <div class="panel-body">
                Currently there are no notes for this video. Feel free to add some,
                by clicking the "<span style="color: #13987e">+ New note</span>"
                button on the top right.
            </div>
        </div>
    </div>
</div>
<div class="modal fade" id="addNote" tabindex="-1" role="dialog" aria-labelledby="myModalLabel" aria-hidden="true">
</div>
#{set 'moreStyles'} #{/set}
<script src="/public/js/timeline.js"></script>
<script>

    $(document).on("mousemove", ".note", function (e) {
        var horizontal_position = e.pageX - this.offsetLeft;
        if (horizontal_position > 100) {
            if (this.offsetLeft - parseInt($("#add-note-pointer").css("marginLeft"), 10) > 100) {
                move_add_pointer_right();
            }
        } else {
            if (this.offsetLeft - parseInt($("#add-note-pointer").css("marginLeft"), 10) < 100)
                move_add_pointer_left();
        }

    })

    function move_add_pointer_right() {
        console.log("move pointer");
        var margin = parseInt($("#add-note-pointer").css("marginLeft"), 10) + 200;
        $("#add-note-pointer").css("marginLeft", margin + "px");
    }
    function move_add_pointer_left() {
        console.log("move pointer");
        var margin = parseInt($("#add-note-pointer").css("marginLeft"), 10) - 200;
        $("#add-note-pointer").css("marginLeft", margin + "px");
    }

    $('#note-content').autogrow();

    initializeTimeline(${video.id});

    var player;
    $("#add-new-note").click(function () {
        if (!$("#new-note").is(":visible")) {
            $("#new-note").slideDown(200);
            $(this).text("Close");
        } else {
            $("#new-note").slideUp(200);
            $(this).text("+ New note");
        }
    })


    var startSeekTime = 0;
    var endSeekTime = 0;

    $("#note-start").change(function () {
        var time = $(this).val().split(":");
        startSeekTime = parseInt(time[0]) * 60 + parseInt(time[1]);
        //player.seekTo(seekTime, false );

        player.cueVideoById("${video.url}", startSeekTime, endSeekTime, "large");
        $("#note-start-int").val(startSeekTime);
    })

    $("#note-end").change(function () {
        var time = $(this).val().split(":");
        endSeekTime = parseInt(time[0]) * 60 + parseInt(time[1]);
        //player.seekTo(seekTime, false );

        player.cueVideoById("${video.url}", startSeekTime, endSeekTime, "large");
        $("#note-end-int").val(endSeekTime);

    })


</script>

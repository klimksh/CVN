#{extends 'main.html' /}
#{set title: "${video.title}" /}
#{stylesheet 'video-page.css'/}

<h3 id="header">CVN - ${video.title}</h3>
<div class="row">
    <div class="container wrap">
        <div id="player"></div>
        <script src="https://www.youtube.com/iframe_api"></script>
    </div>
</div>

<script src="/public/js/timeline.js"></script>
<script src="/public/js/jquery.flip.min.js"></script>

<div class="clearfix"></div>

<div id="slideHandler" class="row">
    <label for="autoslide">
        <input id="autoslide" type="checkbox" checked="checked"/> Update notes during the video
    </label>
</div>
<div class="row">
    <div id="timeline">
        <div id="pastNotes"></div>
        <div id="mainPanel" class="flipbox-container">
            <div id="mainFlipBox">
                <div id="currentNotes"></div>
            </div>
        </div>
        <div id="optionsPanel" class="flipbox-container">
            <div id="options">
                <div id="currentTime">
                    Time<br/>
                    <span id="timer"></span>
                </div>
                <div id="addNoteBtn"  class="btn btn-danger btn-block" onclick="flipMainPanel()">+Note</div>
                <div id="revertFlip" class="btn btn-danger btn-block" onclick="flipMainPanel()" style="display: none"><span class="glyphicon glyphicon-refresh"></span></div>
            </div>
        </div>
        <div id="futureNotes"></div>
    </div>
</div>

<div id="newNoteForm" style="display: none">
    <form class="form-horizontal" style="margin-top: 10px;" role="form">
        <div id="note-title-group" class="form-group">
            <label for="note-title" class="col-sm-2">Title</label>
            <div class="col-sm-10">
                <input type="text" class="form-control" id="note-title" name="note-title" placeholder="Note title..."/>
            </div>
        </div>

        <div id="note-content-group" class="form-group">
            <label for="note-content" class="col-sm-2">Content</label>
            <div class="col-sm-10">
                <textarea class="form-control" placeholder="Note" content="" name="note-content" id="note-content" cols="10" rows="1"></textarea>
            </div>
        </div>

        <div id="note-tags-group" class="form-group">
            <label for="tagsInput" class="col-sm-2">Tags</label>
            <div class="col-sm-10">
                <input type="text" class="form-control" id="tagsInput" name="tagsInput" placeholder="Type tags separated by comma..."/>
            </div>
            <div class="col-sm-10 pull-right" id="tagsList" style="margin:10px 0px"></div>
        </div>

        <input type="text" hidden="hidden" name="video-id" id="video-id" value="${video.id}"/>
        <input type="text" hidden="hidden" name="username" id="username" value="user"/>
        <input type="text" hidden="hidden" name="tags" id="tags" value=""/>
        <div id="saveNoteBtn" class="btn btn-danger">Save note</div>
        <div id="savePrivateNoteBtn" class="btn btn-default">Save as private note</div>
    </form>
    <script src="/public/js/add-tag.js"></script>
    <script src="/public/js/socket.js"></script>
</div>
#{set 'moreStyles'} #{/set}
<div id="test">
    <ul id="thread"></ul>
    <input type="text" class="form-control col-xs-4" id="note-title-data" name="note-title-data"
           placeholder="Note title..."/>

    <textarea class="form-control col-xs-4" placeholder="Note content..." name="note-content-data"
              id="note-content-data" cols="10" rows="2"></textarea>

    <input type="hidden" class="form-control col-xs-4" name="note-start-data" id="note-start-data" value=""/>

*{#{include 'add-tag.html'/} <span class="row" style="margin-top: 20px"></span>}*

    <input type="text" hidden="hidden" name="note-start-data" id="note-start-data" value=""/>
    <input type="text" hidden="hidden" name="note-end-data" id="note-end-data" value=""/>
    <input type="text" hidden="hidden" name="video-id-data" id="video-id-data" value="${video.id}"/>
    <input type="text" hidden="hidden" name="user-email-data" id="user-email-data" value="${session.userEmail}"/>
    <input type="text" hidden="hidden" name="user-name-data" id="user-na,e-data" value="${session.userName}"/>
    <input type="text" hidden="hidden" name="user-id-data" id="user-id-data" value="${session.googleUserId}"/>
    <textarea id="new_note"></textarea>
    <button id="send" class="btn btn-default">Send</button>
</div>
<script>
    $(function() {
        $(document).scrollTop( $("#header").offset().top );
    });


    $(document).on("mousemove", ".note", function (e) {
        var horizontal_position = e.pageX - this.offsetLeft;
        if (horizontal_position > 100) {
            if (this.offsetLeft - parseInt($("#add-note-pointer").css("marginLeft"), 10) > 100) {
                move_add_pointer_right();
            }
        } else {
            if (this.offsetLeft - parseInt($("#add-note-pointer").css("marginLeft"), 10) < 100)
                move_add_pointer_left();
        }

    })

    function move_add_pointer_right() {
        var margin = parseInt($("#add-note-pointer").css("marginLeft"), 10) + 200;
        $("#add-note-pointer").css("marginLeft", margin + "px");
    }
    function move_add_pointer_left() {
        var margin = parseInt($("#add-note-pointer").css("marginLeft"), 10) - 200;
        $("#add-note-pointer").css("marginLeft", margin + "px");
    }

    $('#note-content').autogrow();

    initializeTimeline(${video.id});

    var player;


    function onYouTubeIframeAPIReady() {
        player = new YT.Player('player', {
            height: '430',
            width: '780',
            videoId: '${video.url}',
            events: {
                'onStateChange': onPlayerStateChange
            }
        });
        setTimelineBoxSizes();
    }

    function onPlayerStateChange(event) {
        if (event.data === 1) {  // if the video is playing start catching events
            checkTimePointsOnVideo();
        }
    }

    // !!!contains timer that runs slideTimeline
    function checkTimePointsOnVideo() {
        if (!player.getCurrentTime) {
            return;
        }

        var interval = setInterval(function () {
            player.getPlayerState() // -- Possible values are unstarted (-1), ended (0), playing (1), paused (2), buffering (3), video cued (5).
            if (player.getPlayerState() === 1) {
                var played = Math.round(player.getCurrentTime());
                updateTimeline(played);
            } else if (player.getPlayerState() === 0 || player.getPlayerState() === 2) {
                clearInterval(interval);
            }
        }, 1000);
    }

    var startSeekTime = 0;
    var endSeekTime = 0;

    $("#note-start").change(function () {
        var time = $(this).val().split(":");
        startSeekTime = parseInt(time[0]) * 60 + parseInt(time[1]);

        player.cueVideoById("${video.url}", startSeekTime, endSeekTime, "large");
        $("#note-start-int").val(startSeekTime);
    })

    $("#note-end").change(function () {
        var time = $(this).val().split(":");
        endSeekTime = parseInt(time[0]) * 60 + parseInt(time[1]);
        //player.seekTo(seekTime, false );

        player.cueVideoById("${video.url}", startSeekTime, endSeekTime, "large");
        $("#note-end-int").val(endSeekTime);

    })
</script>
<script type="text/javascript">
    
    
    // Create a socket
    var WS = window['MozWebSocket'] ? MozWebSocket : WebSocket;
    var socket = new WS('@@{LiveAnnotation.WebSocket.stream(video.id)}');

    $('#send').click(function (e) {
        $("#note-start-data").val(Math.round(player.getCurrentTime()));
        var data = $('#test :input').serialize();
        $.post('@{NoteController.saveNote()}', data);
        $('#new_note').val('')

    });

    //pressing 'Enter' instead of clicking
    $('#new_note').keypress(function (e) {
        if (e.charCode == 13 || e.keyCode == 13) {
            $('#send').click()
            e.preventDefault()
        }
    });

    // Message received on the socket
    socket.onmessage = function (event) {
        display(event.data);
    };

    socket.onopen = function (evt) {
        console.log("connected");
    };

    socket.onclose = function (evt) {
        console.log("disconnected");
    };


    socket.onerror = function (evt) {
        console.log("error: " + evt.data);
    };


    // Display a message
    var display = function (event) {
        //document.write(event);
        //(event);
        $('#thread').append('<li>' + event + '</li>');
    }


</script>




